<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HR Dashboard - Posspole</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
    }

    .sidebar {
      background-color: black; 
      color: white;
      width: 240px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      color: white;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      transition: background 0.3s;
    }

    .sidebar a:hover {
      background-color: #1e232b;
    }

    .sidebar a.active {
      background-color: #374151;
      color: white;
    }

    .main-content {
      margin-left: 260px;
      padding: 2rem;
    }

    .download-btn {
      background-color: #000;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .download-btn:hover {
      background-color: #222;
      transform: scale(1.05);
    }

    footer {
      margin-top: 40px;
      background-color: #f9f9f9;
      padding: 20px;
      text-align: center;
      font-size: 14px;
      border-top: 1px solid #e2e2e2;
    }

    input, select, button {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: black;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #333;
    }
  </style>
</head>
<body>

 <!-- Sidebar -->
 <div class="sidebar">
  <img src="/components/posspolelogo.png" alt="Posspole Logo" class="h-6 mb-8 mx-auto">
  <a href="/HR-dashboard/hr.html" class="active hover:bg-gray-700 hover:text-white">Candidates</a>
  <a href="/HR-dashboard/test.html" class="hover:bg-gray-700 hover:text-white">Test</a>
  <a href="/HR-dashboard/report.html" class="hover:bg-gray-700 hover:text-white">Report</a>
  <a href="/login-page/login.html" id="logoutBtn" class="mt-auto hover:bg-gray-700 hover:text-white">Logout</a>
</div>

  <!-- Main Content -->
  <div class="main-content">
    <h1 class="text-4xl font-bold mb-6">HR Dashboard</h1>

    <!-- Search and Filter -->
    <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-wrap gap-4 items-center">
      <input type="text" id="searchName" placeholder="Search by Name" class="w-64">
      <input type="text" id="searchTime" placeholder="Search by Time (e.g., 10:00 AM)" class="w-64">
      <select id="sortBy" class="w-48">
        <option value="">Sort By</option>
        <option value="name-asc">Name A-Z</option>
        <option value="name-desc">Name Z-A</option>
        <option value="time-asc">Time Asc</option>
        <option value="time-desc">Time Desc</option>
      </select>
      <button onclick="applySearch()">Search</button>
      <button onclick="clearSearch()" class="bg-gray-600 hover:bg-gray-800">Clear</button>
    </div>

    <!-- Users Table -->
    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h2 class="text-2xl font-semibold mb-4">Candidates</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left border-collapse">
          <thead class="bg-gray-100 font-semibold">
            <tr>
              <th class="p-3">User ID</th>
              <th class="p-3">Name</th>
              <th class="p-3">Email</th>
              <th class="p-3">Resume</th>
              <th class="p-3">Assign</th> <!-- New column -->
            </tr>
          </thead>
          <tbody id="userTable" class="divide-y">
            <!-- Rows go here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>About Us | <a href="https://posspole.com/" target="_blank" class="text-blue-600 underline">Visit Posspole</a></p>
      <p>&copy; 2025 Posspole. All rights reserved.</p>
    </footer>
  </div>

  <!-- JavaScript -->
  <script>
let users = [];
let availableTests = [];

// Fetch users
async function fetchUsers() {
  try {
    const res = await fetch("http://localhost:5001/api/auth/hr/candidates");
    const data = await res.json();
    users = data.users;
    renderUsers(users);
  } catch (err) {
    console.error("Error fetching users:", err);
    alert("Failed to load candidates.");
  }
}

// Fetch available tests for assignment
async function fetchAvailableTests() {
  try {
    const res = await fetch("/api/tests");
    const data = await res.json();
    availableTests = data.tests || [];
  } catch (err) {
    availableTests = [];
    console.error("Error fetching tests:", err);
  }
}

    function renderUsers(data) {
      const table = document.getElementById("userTable");
      table.innerHTML = "";
      data.forEach(user => {
        table.innerHTML += `
          <tr>
            <td class="p-3">${user._id}</td>
            <td class="p-3">${user.fullName}</td>
            <td class="p-3">${user.email}</td>
            <td class="p-3">
              <a href="${user.resumeUrl || '#'}" class="download-btn" download>Download</a>
            </td>
            <td class="p-3">
              <button class="assign-candidate-btn bg-blue-600 text-white px-3 py-1 rounded"
                data-user-id="${user._id}" data-user-name="${user.fullName}" data-user-email="${user.email}">
                Assign
              </button>
              <span class="assign-status ml-2 text-green-600 text-sm" style="display:none;">Assigned</span>
            </td>
          </tr>
        `;
      });
    }

    function parseTime(timeStr) {
      const [time, meridian] = timeStr.split(" ");
      let [hours, minutes] = time.split(":").map(Number);
      if (meridian === "PM" && hours !== 12) hours += 12;
      if (meridian === "AM" && hours === 12) hours = 0;
      return hours * 60 + minutes;
    }

    function applySearch() {
      const nameInput = document.getElementById("searchName").value.toLowerCase();
      const timeInput = document.getElementById("searchTime").value.toLowerCase();
      const sortBy = document.getElementById("sortBy").value;

      let filtered = users.filter(user =>
        user.name.toLowerCase().includes(nameInput) &&
        user.time.toLowerCase().includes(timeInput)
      );

      switch (sortBy) {
        case "name-asc":
          filtered.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case "name-desc":
          filtered.sort((a, b) => b.name.localeCompare(a.name));
          break;
        case "time-asc":
          filtered.sort((a, b) => parseTime(a.time) - parseTime(b.time));
          break;
        case "time-desc":
          filtered.sort((a, b) => parseTime(b.time) - parseTime(a.time));
          break;
      }

      renderUsers(filtered);
    }

    function clearSearch() {
      document.getElementById("searchName").value = "";
      document.getElementById("searchTime").value = "";
      document.getElementById("sortBy").value = "";
      renderUsers(users);
    }

    window.onload = () => {
      fetchUsers();
      fetchAvailableTests();
    };
      // Universal logout confirmation for all HR-dashboard pages
    function setupLogoutButton() {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                // Use a custom modal for confirmation with Cancel/Logout buttons
                if (document.getElementById('logout-modal')) return; // Prevent multiple modals

                const modal = document.createElement('div');
                modal.id = 'logout-modal';
                modal.style.position = 'fixed';
                modal.style.top = 0;
                modal.style.left = 0;
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.4)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = 9999;
                modal.innerHTML = `
                  <div style="background:#fff;padding:2rem 2.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:350px;text-align:center;">
                    <h2 class="text-xl font-bold mb-4">Log out?</h2>
                    <p class="mb-6">Are you sure you want to log out?</p>
                    <div style="display:flex;gap:1rem;justify-content:center;">
                      <button id="cancel-logout" style="padding:0.5rem 1.5rem;border-radius:8px;background:#e5e7eb;color:#222;border:none;font-weight:500;cursor:pointer;">Cancel</button>
                      <button id="confirm-logout" style="padding:0.5rem 1.5rem;border-radius:8px;background:#000;color:#fff;border:none;font-weight:500;cursor:pointer;">Logout</button>
                    </div>
                  </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('cancel-logout').onclick = function() {
                    document.body.removeChild(modal);
                };
                document.getElementById('confirm-logout').onclick = function() {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login-page/login.html';
                };
            });
        }
    }
    setupLogoutButton();

    // Assign button logic with test selection modal
    let assignPopup = null;
    let assignPopupBackdrop = null;

    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('assign-candidate-btn')) {
        const btn = e.target;
        const userId = btn.getAttribute('data-user-id');
        const userName = btn.getAttribute('data-user-name');
        const userEmail = btn.getAttribute('data-user-email');

        // Remove any existing popup
        if (assignPopup) assignPopup.remove();
        if (assignPopupBackdrop) assignPopupBackdrop.remove();

        // Create backdrop
        assignPopupBackdrop = document.createElement('div');
        assignPopupBackdrop.style.position = 'fixed';
        assignPopupBackdrop.style.top = 0;
        assignPopupBackdrop.style.left = 0;
        assignPopupBackdrop.style.width = '100vw';
        assignPopupBackdrop.style.height = '100vh';
        assignPopupBackdrop.style.background = 'rgba(0,0,0,0.4)';
        assignPopupBackdrop.style.zIndex = 9998;
        document.body.appendChild(assignPopupBackdrop);

        // Create popup
        assignPopup = document.createElement('div');
        assignPopup.style.position = 'fixed';
        assignPopup.style.top = '50%';
        assignPopup.style.left = '50%';
        assignPopup.style.transform = 'translate(-50%, -50%)';
        assignPopup.style.background = '#fff';
        assignPopup.style.padding = '2rem 2.5rem';
        assignPopup.style.borderRadius = '12px';
        assignPopup.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
        assignPopup.style.zIndex = 9999;
        assignPopup.style.maxWidth = '350px';
        assignPopup.style.textAlign = 'center';

        // Build test dropdown
        let testOptions = availableTests.length
          ? availableTests.map(t => `<option value="${t._id || t.id}">${t.name}</option>`).join('')
          : `<option disabled>No tests available</option>`;

        assignPopup.innerHTML = `
          <button id="close-assign-popup" style="position:absolute;top:10px;right:16px;font-size:22px;background:none;border:none;cursor:pointer;color:#888;">&times;</button>
          <h2 class="text-xl font-bold mb-4">Assign Test</h2>
          <p class="mb-2"><strong>Candidate:</strong> ${userName} (${userEmail})</p>
          <div class="mb-4">
            <label for="assign-test-select" class="block mb-1 font-semibold">Select Test</label>
            <select id="assign-test-select" class="w-full p-2 border border-gray-300 rounded">
              ${testOptions}
            </select>
          </div>
          <div class="flex gap-2 justify-center mt-6">
            <button id="confirm-assign-popup" class="bg-black text-white px-4 py-2 rounded">Assign</button>
            <button id="cancel-assign-popup" class="bg-gray-300 text-black px-4 py-2 rounded">Cancel</button>
          </div>
        `;
        document.body.appendChild(assignPopup);

        // Close (X) button handler
        document.getElementById('close-assign-popup').onclick = function() {
          assignPopup.remove();
          assignPopupBackdrop.remove();
        };

        // Cancel handler
        document.getElementById('cancel-assign-popup').onclick = function() {
          assignPopup.remove();
          assignPopupBackdrop.remove();
        };

        // Confirm handler
        document.getElementById('confirm-assign-popup').onclick = async function() {
          const select = document.getElementById('assign-test-select');
          const testId = select.value;
          const testName = select.options[select.selectedIndex]?.text || 'Test';
          if (!testId) {
            alert('Please select a test.');
            return;
          }
          const confirmBtn = document.getElementById('confirm-assign-popup');
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Assigning...';
          try {
            const res = await fetch('/api/tests/assign', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId, testId })
            });
            const result = await res.json();
            if (res.ok) {
              btn.textContent = 'Assigned';
              btn.classList.remove('bg-blue-600');
              btn.classList.add('bg-gray-400');
              btn.disabled = true;
              btn.nextElementSibling.style.display = 'inline';
              alert('Assignment email sent to ' + userName + ' for test "' + testName + '"!');
              assignPopup.remove();
              assignPopupBackdrop.remove();
            } else {
              confirmBtn.textContent = 'Assign';
              confirmBtn.disabled = false;
              alert(result.message || 'Failed to assign test.');
            }
          } catch (err) {
            confirmBtn.textContent = 'Assign';
            confirmBtn.disabled = false;
            alert('Network error.');
          }
        };
      }
    });
  </script>
  <script src="/user-dashboard/user-page.js"></script>
</body>
</html>
